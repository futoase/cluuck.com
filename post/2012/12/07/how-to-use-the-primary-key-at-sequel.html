<!doctype html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />

  <title>Futoase development blog - How to use the primary key at sequel</title>
  <link rel="stylesheet" href="/stylesheets/pygments.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/solarized-light.min.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/main.css" type="text/css" />

</head>


  <body>
    <header>
  <div>
    <a class="title" href="/">futoase development blog.</a>
    <span class="menu">
      <ul>
        <li><a href="/articles.html">articles</a></li>
        <li><a href="/tags.html">tags</a></li>
        <li><a href="/year.html">year</a></li>
	<li><a href="/me.html">me</a></li>
	<li><a href="/feed.xml">feed</a></li>
      </ul> 
    </span>
  </div>
</header>


    <div id="container">
      <div id="main" role="main">
        <h1>SequelのModelでPrimary keyで指定した値を設定したい場合</h1>

<p>ふつーに<a href="http://sequel.rubyforge.org/">Sequel</a>でTableとModel作って、
Primary keyに好きな値を指定してレコードを作ろうとすると
エラーを吐いてしまいます。</p>
<pre class="highlight ruby"><span class="c1"># -*- coding:utf-8 -*-</span>

<span class="nb">require</span> <span class="s1">&#39;sequel&#39;</span>

<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="nf">.plugin</span><span class="p">(</span><span class="ss">:timestamps</span><span class="p">,</span> <span class="ss">:update_on_create</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span>
<span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="nf">.sqlite</span>
<span class="no">DB</span><span class="nf">.create_table</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">primary_key</span> <span class="ss">:id</span>
  <span class="nb">String</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
  <span class="no">DateTime</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
  <span class="no">DateTime</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
<span class="k">end</span>

<span class="k">class </span><span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">User</span><span class="nf">.new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mario&quot;</span><span class="p">)</span><span class="nf">.save</span>
<span class="no">User</span><span class="nf">.new</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Luigi&quot;</span><span class="p">)</span><span class="nf">.save</span>

<span class="nb">puts</span> <span class="s2">&quot;Mario: &quot;</span> <span class="o">+</span> <span class="no">User</span><span class="nf">.find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mario&quot;</span><span class="p">)</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="nf">.to_s</span>
<span class="nb">puts</span> <span class="s2">&quot;Luigi: &quot;</span> <span class="o">+</span> <span class="no">User</span><span class="nf">.find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Luigi&quot;</span><span class="p">)</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="nf">.to_s</span>
</pre>
<p>以上のコードを実行すると、</p>
<pre class="highlight text">vendor/bundle/ruby/1.9.1/gems/sequel-3.42.0/lib/sequel/model/base.rb:1775:in `block in set_restricted&#39;: id is a restricted primary key (Sequel::Error)
</pre>
<p>うおっ、Luigiのidに3を指定することができない&hellip;</p>

<p></p>

<h1>unrestrict<em>primary</em>key</h1>

<p>Modelに対し<a href="http://sequel.rubyforge.org/rdoc/classes/Sequel/Model/ClassMethods.html#method-i-unrestrict_primary_key">unrestrict<em>primary</em>key</a>を定義することで問題が解決します。
本来のprimary_keyの役割は、とか思ったりするけど仕方ない場面があったりするでしょう。
(例えばデータ依存度合いが大きく、結合度合いも大きい仕方なしなコードの動作検証したいとか)</p>

<p>上記のコードに対し対応を行ったコードを提示いたします。</p>
<pre class="highlight ruby"><span class="c1"># -*- coding:utf-8 -*-</span>

<span class="nb">require</span> <span class="s1">&#39;sequel&#39;</span>

<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="nf">.plugin</span><span class="p">(</span><span class="ss">:timestamps</span><span class="p">,</span> <span class="ss">:update_on_create</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span>
<span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="nf">.sqlite</span>
<span class="no">DB</span><span class="nf">.create_table</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">primary_key</span> <span class="ss">:id</span>
  <span class="nb">String</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
  <span class="no">DateTime</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
  <span class="no">DateTime</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
<span class="k">end</span>

<span class="k">class </span><span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span>
  <span class="n">unrestrict_primary_key</span>
<span class="k">end</span>

<span class="c1"># 以下の形でもOK</span>
<span class="c1"># User.unrestrict_primary_key</span>

<span class="no">User</span><span class="nf">.new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mario&quot;</span><span class="p">)</span><span class="nf">.save</span>
<span class="no">User</span><span class="nf">.new</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Luigi&quot;</span><span class="p">)</span><span class="nf">.save</span>

<span class="nb">puts</span> <span class="s2">&quot;Mario: &quot;</span> <span class="o">+</span> <span class="no">User</span><span class="nf">.find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mario&quot;</span><span class="p">)</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="nf">.to_s</span>
<span class="nb">puts</span> <span class="s2">&quot;Luigi: &quot;</span> <span class="o">+</span> <span class="no">User</span><span class="nf">.find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Luigi&quot;</span><span class="p">)</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="nf">.to_s</span>
</pre>
<p>以上の形に修正し、コードを実行します。</p>
<pre class="highlight text">&gt; bundle exec ruby test.rb
Mario: 1
Luigi: 3
</pre>
<p>解決しましたね。</p>

      </div>
    </div>

    <footer>
  <div>futoase 2009-2013 (c)</div>
</footer>

  </body>
</html>
