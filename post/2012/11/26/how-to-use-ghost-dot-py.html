<!doctype html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />

  <title>Futoase development blog - How to use Ghost.py</title>
  <link rel="stylesheet" href="/stylesheets/pygments.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/solarized-light.min.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/main.css" type="text/css" />

</head>


  <body>
    <header>
  <div>
    <a class="title" href="/">futoase development blog.</a>
    <span class="menu">
      <ul>
        <li><a href="/articles.html">articles</a></li>
        <li><a href="/tags.html">tags</a></li>
        <li><a href="/year.html">year</a></li>
	<li><a href="/me.html">me</a></li>
	<li><a href="/feed.xml">feed</a></li>
      </ul> 
    </span>
  </div>
</header>


    <div id="container">
      <div id="main" role="main">
        <h1>Ghost.py</h1>

<p><a href="http://jeanphix.me/Ghost.py/">Ghost.py</a>という、<a href="http://www.pyside.org">PySide</a> or <a href="http://www.riverbankcomputing.co.uk/software/pyqt/intro">PyQt</a>を利用し<a href="http://trac.webkit.org/wiki/QtWebKit">QtWebKit</a>を利用するためのラッパーが存在します。似たようなものだと<a href="http://phantomjs.org">phantom.js</a>や<a href="https://github.com/thoughtbot/capybara-webkit">Capybara-WebKit</a>があります。これを試しに使ってみようかな〜と思ったので以下に使用手順をMac OS X、Ubuntu Server 12.04.1 LTSでの内容を書きます。</p>

<p>Ghost.pyはPySide,PyQtどちらでも利用できるように書かれているのですが、今回はPySideを利用する形をとりました。</p>

<h2>Ghost.pyとは</h2>

<ul>
<li>PySide及びPyQtを利用しQtWebKitを使ったウェブブラウジングが可能なラッパー

<ul>
<li>Javascriptの実行もOK。</li>
<li>QtWebKitを利用してスクショが撮れます。</li>
</ul></li>
</ul>

<p></p>

<h1>Mac OS X で利用</h1>

<p>以下には、Mac OS X 10.8.2 Mountain Lion で利用するための手順を記載します。</p>

<h2>homebrew で環境を構築</h2>

<p>Mac OS X でQt周りを手作業で環境構築するとだるそうなので<a href="http://mxcl.github.com/homebrew/">homebrew</a>を利用してインストールするようにします。</p>
<pre class="highlight text">&gt; brew install python piside
</pre>
<p>PySideは以下のディレクトリに入ります。</p>
<pre class="highlight text">&gt; /usr/local/Cellar/python/2.7.3/lib/python2.7/site-packages/PySide
</pre>
<p><a href="https://github.com/mxcl/homebrew/blob/master/Library/Formula/pyside.rb">Formulaはこちら</a></p>

<p>続けて、<a href="http://pypi.python.org/pypi/distribute">distribute</a>をインストールします。</p>
<pre class="highlight text">&gt; curl -O http://python-distribute.org/distribute_setup.py
&gt; python distribute_setup.py
</pre>
<p>easy_installがインストールできたら続けて<a href="http://pypi.python.org/pypi/pip">pip</a>を入れます。</p>
<pre class="highlight text">&gt; rehash
&gt; easy_install-2.7 pip
</pre>
<p>さらに、pipを利用して<a href="http://www.virtualenv.org/en/latest/">virtualenv</a>を入れます。</p>
<pre class="highlight text">&gt; pip install virtualenv
</pre>
<p>以上で気軽に汚せる環境を整える準備ができたので、$HOME/local以下にでもvirtualenvで環境を整えましょう。</p>
<pre class="highlight text">&gt; mkdir -p $HOME/local
&gt; virtuelenv $HOME/local/python --system-site-packages
</pre>
<p>(注) <a href="http://www.virtualenv.org/en/latest/#the-system-site-packages-option">&ndash;system-site-packageオプション</a>は、ベースとなるPythonにインストールされているsite-packagesを利用するためには必須となるオプションです。</p>

<p>以上でGhost.pyを手軽にMac OS X上でテストできる環境が整いました。早速Ghost.pyをインストールすることにします。</p>

<h2>Ghost.pyのテスト</h2>

<p>先ほどvirtualenvで作成したプライベートなpython環境上でインストール、実行をしていきます。virtualenvで作成したpythonの環境を利用する場合は、以下の形でactivateスクリプトをsourceコマンドで設定として読み出します。そうするとpythonのパスがvirtualenvで作成したpythonの環境のものに設定されます。元の環境に戻る場合は&quot;deactivate&quot;コマンドを実行してください。</p>
<pre class="highlight text">&gt; source $HOME/local/python/bin/activate
(python)&gt; 
</pre>
<p>Ghost.pyをpip経由でインストールします</p>
<pre class="highlight text">(python)&gt; pip install Ghost.py
</pre>
<p>インストールが終わったら、オフィシャルサイトに掲載されているCode snipetを実行してみます。</p>
<pre class="highlight python"><span class="p">(</span><span class="n">python</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">python</span>
<span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span> <span class="mi">12</span> <span class="mi">2012</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="p">)[</span><span class="n">GCC</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="n">Compatible</span> <span class="n">Apple</span> <span class="n">Clang</span> <span class="mf">3.1</span> <span class="p">(</span><span class="n">tags</span><span class="o">/</span><span class="n">Apple</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="mf">318.0</span><span class="o">.</span><span class="mi">45</span><span class="p">)]</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">ghost</span> <span class="kn">import</span> <span class="n">Ghost</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span> <span class="o">=</span> <span class="n">Ghost</span><span class="p">()</span>
<span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">24</span> <span class="mi">22</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mf">43.762</span> <span class="n">python</span><span class="p">[</span><span class="mi">97682</span><span class="p">:</span><span class="mi">707</span><span class="p">]</span> <span class="o">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Method</span> <span class="n">userSpaceScaleFactor</span> <span class="ow">in</span> <span class="k">class</span> <span class="nc">NSView</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="n">on</span> <span class="mf">10.7</span> <span class="ow">and</span> <span class="n">later</span><span class="o">.</span> <span class="n">It</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">new</span> <span class="n">applications</span><span class="o">.</span> <span class="n">Use</span> <span class="n">convertRectToBacking</span><span class="p">:</span> <span class="n">instead</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="p">,</span> <span class="n">extra_resources</span> <span class="o">=</span> <span class="n">ghost</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;http://jeanphi.fr&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">assert</span> <span class="n">page</span><span class="o">.</span><span class="n">http_status</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="s">&#39;jeanphi&#39;</span> <span class="ow">in</span> <span class="n">ghost</span><span class="o">.</span><span class="n">content</span>
</pre>
<p>途中で出てきた、以下のエラー</p>
<pre class="highlight text">2012-11-24 22:55:43.762 python[97682:707] *** WARNING: Method userSpaceScaleFactor in class NSView is deprecated on 10.7 and later. It should not be used in new applications. Use convertRectToBacking: instead.
</pre>
<p>このエラーについてぐぐってみたところ、<a href="http://victorquinn.com/blog/2012/10/11/using-capybara-and-rspec-to-test-drupal/">問題ありませんとか書かれてるエントリ</a>が出てくるぐらいだったので、developer.apple.comのドキュメントを調べたら<a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/ApplicationKit/Classes/NSScreen_Class/DeprecationAppendix/AppendixADeprecatedAPI.html%23//apple_ref/occ/instm/NSScreen/userSpaceScaleFactor">userSpaceScaleFactor methodはdeprecateされたことが確認できました</a>。</p>

<p>ghost.contentは、オフィシャルのcode snipetを見れば推測できると思うけど取得コンテンツの中身が入っています。</p>
<pre class="highlight html">u&#39;<span class="cp">&lt;!DOCTYPE html&gt;</span><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;fr&quot;</span><span class="nt">&gt;&lt;head&gt;</span>\n        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>\n        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">&gt;</span>\n        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;alternate&quot;</span> <span class="na">type=</span><span class="s">&quot;application/atom+xml&quot;</span> <span class="na">title=</span><span class="s">&quot;Post feeds&quot;</span> <span class="na">href=</span><span class="s">&quot;/atom.xml&quot;</span><span class="nt">&gt;</span>\n…
</pre>
<p>ghost.openの返り値については2つの値が含まれたタプルとなっており、(取得できたresource且つ指定したurlと同一のresouce,resourceすべて)となっています。resourceについてはリソースからリンクが張られているjavascript、cssを含みます。</p>
<pre class="highlight python"><span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">ghost</span><span class="o">.</span><span class="n">ghost</span><span class="o">.</span><span class="n">HttpResource</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10747bd10</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ghost</span><span class="o">.</span><span class="n">ghost</span><span class="o">.</span><span class="n">HttpResource</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10747bd90</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ghost</span><span class="o">.</span><span class="n">ghost</span><span class="o">.</span><span class="n">HttpResource</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10747be10</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ghost</span><span class="o">.</span><span class="n">ghost</span><span class="o">.</span><span class="n">HttpResource</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10747bf10</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ghost</span><span class="o">.</span><span class="n">ghost</span><span class="o">.</span><span class="n">HttpResource</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x107489050</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ghost</span><span class="o">.</span><span class="n">ghost</span><span class="o">.</span><span class="n">HttpResource</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x107489150</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_resources</span><span class="p">)</span>
<span class="mi">6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
<span class="s">u&#39;http://jeanphi.fr/&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
<span class="s">u&#39;http://jeanphix.me/&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
<span class="s">u&#39;http://jeanphix.me/static/css/normalize.css/normalize.css&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
<span class="s">u&#39;http://jeanphix.me/static/css/pygments.css&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
<span class="s">u&#39;http://jeanphix.me/static/css/style.css&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">extra_resources</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
<span class="s">u&#39;https://a248.e.akamai.net/assets.github.com/img/7afbc8b248c68eb468279e8c17986ad46549fb71/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67&#39;</span>
</pre>
<p>ghost.openの返り値については以下のコードを見ることで確認できます。</p>
<pre class="highlight python"><span class="k">def</span> <span class="nf">wait_for_page_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">&quot;&quot;&quot;Waits until page is loaded, assumed that a page as been requested.
    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">,</span>
        <span class="s">&#39;Unable to load requested page&#39;</span><span class="p">)</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_last_resources</span><span class="p">()</span>
    <span class="n">page</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_frame</span><span class="o">.</span><span class="n">url</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">resource</span>
    <span class="k">return</span> <span class="n">page</span><span class="p">,</span> <span class="n">resources</span>
</pre>
<p>(注)細かくコードの内容を確認するには<a href="https://github.com/jeanphix/Ghost.py/blob/781dd0a16d7cc0c47429f28d7aed4236e8b2f74e/ghost/ghost.py#L45">GhostWebPage Class</a>、及びその親クラスである<a href="http://srinikom.github.com/pyside-docs/PySide/QtWebKit/QWebPage.html">QtWebkit.QWebPage</a>の内容を見ないといけないので割愛します。。。(あとで書くかも)</p>

<h3>yahoo.co.jpのスクショを撮る</h3>

<p>サイトのスクショはとても簡単に撮れます。</p>
<pre class="highlight python"><span class="o">&gt;&gt;&gt;</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ghost</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;http://www.yahoo.co.jp/&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span><span class="o">.</span><span class="n">capture_to</span><span class="p">(</span><span class="s">&quot;render.png&quot;</span><span class="p">)</span>
</pre>
<p>PythonのREPLを起動した時のカレントディレクトリ以下にrender.pngができています。内容を見てみるときちんとyahoo.co.jpのキャプチャができていることを確認することができます。</p>
<pre class="highlight text">&gt; open render.png
</pre>
<p><img alt="Screen shot" src="https://dl.dropbox.com/u/614755/futoase.github.com/how-to-use-ghost-py/render.png" /></p>

<p>バッチリ写ってる！…ウインドウサイズは変えることはできないんだろうか？と思って<a href="https://github.com/jeanphix/Ghost.py/blob/781dd0a16d7cc0c47429f28d7aed4236e8b2f74e/ghost/ghost.py#L168">Ghost.pyのソースをチェックしてみたらviewport_sizeに渡す形になっていました。</a>デフォルト値は800x600。</p>
<pre class="highlight python"><span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span> <span class="o">=</span> <span class="n">Ghost</span><span class="p">(</span><span class="n">viewport_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">))</span>
<span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">24</span> <span class="mi">23</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">14.216</span> <span class="n">python</span><span class="p">[</span><span class="mi">97814</span><span class="p">:</span><span class="mi">707</span><span class="p">]</span> <span class="o">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Method</span> <span class="n">userSpaceScaleFactor</span> <span class="ow">in</span> <span class="k">class</span> <span class="nc">NSView</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="n">on</span> <span class="mf">10.7</span> <span class="ow">and</span> <span class="n">later</span><span class="o">.</span> <span class="n">It</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">new</span> <span class="n">applications</span><span class="o">.</span> <span class="n">Use</span> <span class="n">convertRectToBacking</span><span class="p">:</span> <span class="n">instead</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;http://yahoo.co.jp/&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span><span class="o">.</span><span class="n">capture_to</span><span class="p">(</span><span class="s">&quot;render_1024x768.png&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">exit</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="nb">open</span> <span class="n">render_1024x768</span><span class="o">.</span><span class="n">png</span>
</pre>
<p><img alt="Screen shot" src="https://dl.dropbox.com/u/614755/futoase.github.com/how-to-use-ghost-py/render_1024x768.png" /></p>

<p>きちんと解像度を変更した形でスクショを撮ることができました。</p>

<h2>動的なサイトのテスト</h2>

<p>オフィシャルのサンプルだと<a href="http://jeanphix.me/Ghost.py/#javascript">DOMを操作する旨のCode snipetが載っています。</a>ということでテスト的な動的サイトを用意して、Ghost.pyで操作できるか確認してみます。</p>

<p>簡単なhtmlとjsとcssをこさえてテスト環境を作ります。</p>

<p>{% gist 4149488 %}
{% gist 4149492 %}
{% gist 4149495 %}</p>

<p>内容はしょぼくて、&quot;fire&quot;ボタンを押下すると&quot;input[name=&lsquo;smile&rsquo;]&ldquo;要素のvalueを&quot;precure!&quot;に設定するサンプルです。</p>

<p><a href="https://dl.dropbox.com/u/614755/futoase.github.com/how-to-use-ghost-py/ghost-test.html">DropBox上にあげてあるサンプル</a></p>

<p>Ghost.pyを利用して、&quot;fire&quot;ボタンをクリックし、&quot;input[name=&lsquo;smile&rsquo;]&quot;要素のvalueを&quot;precure!&quot;に設定した後、&quot;input[name=&lsquo;smile&rsquo;]&quot;要素の内容を取得して返す短いコードを書いてみます。</p>
<pre class="highlight python"><span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span> <span class="o">=</span> <span class="n">Ghost</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;https://dl.dropbox.com/u/614755/futoase.github.com/tried-using-ghost-py/ghost-test.html&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span><span class="o">.</span><span class="nb">eval</span><span class="n">uate</span><span class="p">(</span><span class="s">&quot;document.getElementById(&#39;fire&#39;).click(); document.getElementsByName(&#39;smile&#39;)[0].value;&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="s">u&#39;precure!&#39;</span><span class="p">,</span> <span class="p">[])</span>
</pre>
<p>きちんとvalueの中身が取れています。よかった。</p>

<h1>Ubuntu Server での動作</h1>

<p><a href="http://www.ubuntu.com/download/server">Ubuntu Server 12.04.1 LTS</a> をVirtualBoxを利用してゲスト上にインストールし、動作確認を行います。Xが動作していない環境での動作を想定しています。(エロ画像とかなんかまあそんな感じのクローラ作るときとか。)
Pythonはソースコードをオフィシャルから落としてインストールする形を取ります。</p>

<p>VirtualBoxで作成するVMについては、ネットワークの項でホストオンリーアダプタを追加しておくことを忘れないようにしておきます。(ホストと通信できなくなるから)</p>

<p><img alt="Screen shot" src="https://dl.dropbox.com/u/614755/futoase.github.com/how-to-use-ghost-py/virtual-box-network-adaptor.png" /></p>

<p>ホストオンリーアダプタの設定が終わったら適切な感じでUbuntu Server 12.04.1 LTSをインストールしてください。(OpenSSH Serverパッケージを選択し忘れないように)</p>

<p>ネットワーク設定は以下の要領で行います。</p>

<p>追加したホストオンリーアダプタが有効か、確認します。</p>
<pre class="highlight text">&gt; /sbin/ifconfig -a
</pre>
<p>&hellip;ホストオンリーアダプタが見つかったら、/etc/networking/interfacesに以下の項目を追記します。</p>
<pre class="highlight text">auto eth1
iface eth1 inet dhcp
</pre>
<p>interfacesの編集が終わったら、/etc/init.d/networking restart をします。(update-rc.d使えとかはまた後で)</p>

<p>VirtualBoxのVMを直接操作するのはだるいので、Mac OS Xのターミナル経由で操作しましょう&hellip;だるいし。</p>

<h2>Ghost.pyを実行するための環境整備</h2>

<p>まだまだ続く&hellip; Pythonのセットアップなど。</p>

<h3>Pythonのセットアップ</h3>

<p>まず、Pythonのビルドに必要なパッケージ群をインストールします。</p>
<pre class="highlight text">&gt; sudo apt-get update
&gt; sudo apt-get install build-essential zlib1g-dev libbz2-dev libreadline6-dev libsqlite3-dev libssl-dev
&gt; mkdir ~/download
&gt; cd ~/download
&gt; curl -O http://www.python.org/ftp/python/2.7.3/Python-2.7.3.tgz
&gt; tar -xvzf Python-2.7.3.tgz
&gt; mkdir ~/local
&gt; cd Python-2.7.3
</pre>
<p>共通ライブラリ(&ndash;enable-sharedオプションをつける)にしないとpyside-setupでコケるため(<a href="https://github.com/PySide/pyside-setup/commit/b63c2f35b268f270a926e2f40f0042d9e7507da6">対策のコミット</a>が入ってるのを確認したがだめだった&hellip;)、<a href="https://twitter.com/methane">@methane</a>さんの<a href="http://qiita.com/items/bf0b74550bee125cdea4">Qitaの投稿</a>を参考に以下の形でビルドオプションを付け、Pythonをビルドします。ただ共有ライブラリオプションを有効にしてもzlibとかそこら辺のライブラリをビルドするときにライブラリパスを通さないととかめんどいことが発生するので&hellip;</p>
<pre class="highlight text">&gt; ./configure --prefix=$HOME/local/Python-2.7.3 --enable-shared \
  LDFLAGS=-Wl,-rpath,$HOME/local/Python-2.7.3/lib
&gt; make
&gt; make install
&gt; make clean
</pre>
<p>インストールに成功したら、~/.bashrcにPATHを通します。</p>
<pre class="highlight text">&gt; export PATH=&quot;$HOME/local/Python-2.7.3/bin:$PATH&quot;;
&gt; source ~/.bashrc
</pre>
<p>distribute、pipのインストールを行います。</p>
<pre class="highlight text">&gt; mkdir ~/download
&gt; cd ~/download
&gt; curl -O http://python-distribute.org/distribute_setup.py
&gt; python distribute_setup.py
&gt; rehash
&gt; easy_install-2.7 pip
</pre>
<p>Qtやcmakeをインストールします。<a href="http://pypi.python.org/pypi/PySide#installing-pyside-from-source-on-a-unix-system-ubuntu-12-04-lts">PySideのPyPIに書かれている手順</a>を参考に、必要なaptパッケージをインストールします。</p>
<pre class="highlight text">&gt; sudo apt-get install qt-sdk cmake git
</pre>
<p>virtualenvを使ってでテストできる環境を構築します。
この時にPySideとGhost.pyをpipを利用してインストールします。</p>
<pre class="highlight text">&gt; pip install virtualenv
&gt; cd
&gt; mkidr ghost
&gt; rehash
&gt; virtualenv-2.7 ghost/python
&gt; source ghost/python/bin/activate
(python)&gt; rehash
(python)&gt; pip install PySide
(python)&gt; pip install Ghost.py
</pre>
<p>インストールが終わったので早速テストを&hellip;</p>
<pre class="highlight python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">ghost</span> <span class="kn">import</span> <span class="n">Ghost</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span> <span class="o">=</span> <span class="n">Ghost</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">&quot;/home/futoase/ghost/python/lib/python2.7/site-packages/ghost/ghost.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">180</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__init__</span>
    <span class="s">&#39;an X instance&#39;</span><span class="p">)</span>
<span class="n">Exception</span><span class="p">:</span> <span class="n">Xvfb</span> <span class="ow">is</span> <span class="n">required</span> <span class="n">to</span> <span class="n">a</span> <span class="n">ghost</span> <span class="n">run</span> <span class="n">oustside</span> <span class="n">an</span> <span class="n">X</span> <span class="n">instance</span>
</pre>
<p>&hellip; <a href="http://en.wikipedia.org/wiki/Xvfb">Xvfb</a>の設定をしなければ。(Xvfbは、Xの仮想フレームバッファです)。</p>
<pre class="highlight text">&gt; sudo apt-get install xvfb libicu48 xfonts-100dpi xfonts-75dpi xfonts-cyrillic xfonts-scalable x-ttcidfont-conf
</pre>
<p>(注)以上のパッケージをインストールしても、以下のエラーが出てしまうのですがここでは割愛します&hellip;設定ファイルをいじってコメントアウトすれば良いだけ。</p>
<pre class="highlight text">[dix] Could not init font path element /var/lib/defoma/x-ttcidfont-conf.d/dirs/TrueType, removing from list!
</pre><pre class="highlight text">&gt; rehash
&gt; Xvfb :10 -screen 0 1024x768x24 &amp;
</pre>
<p>Xvfbが起動したら、早速再テストしてみます。</p>
<pre class="highlight python"><span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Nov</span> <span class="mi">25</span> <span class="mi">2012</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">34</span><span class="p">)[</span><span class="n">GCC</span> <span class="mf">4.6</span><span class="o">.</span><span class="mi">3</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux2</span>
<span class="n">Type</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">ghost</span> <span class="kn">import</span> <span class="n">Ghost</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ghost</span> <span class="o">=</span> <span class="n">Ghost</span><span class="p">()</span>
<span class="p">[</span><span class="n">dix</span><span class="p">]</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">init</span> <span class="n">font</span> <span class="n">path</span> <span class="n">element</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">defoma</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">ttcidfont</span><span class="o">-</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="nb">dir</span><span class="n">s</span><span class="o">/</span><span class="bp">True</span><span class="n">Type</span><span class="p">,</span> <span class="n">removing</span> <span class="kn">from</span> <span class="nn">list</span><span class="err">!
&gt;&gt;&gt;</span> <span class="nn">page</span><span class="err">,</span> <span class="nn">resources</span> <span class="err">=</span> <span class="nn">ghost.open</span><span class="err">(&quot;</span><span class="nn">http</span><span class="err">://</span><span class="nn">yahoo.co.jp</span><span class="err">&quot;)
&gt;&gt;&gt;</span> <span class="nn">page.http_status200</span><span class="err">
&gt;&gt;&gt;</span> <span class="err">&#39;</span><span class="nn">Yahoo</span><span class="err">&#39;</span> <span class="nn">in</span> <span class="nn">ghost.contentTrue</span><span class="err">
&gt;&gt;&gt;</span> <span class="nn">ghost.capture_to</span><span class="err">(&#39;</span><span class="nn">yahoo.png</span><span class="err">&#39;)
</span></pre>
<p><img alt="Screen shot" src="https://dl.dropbox.com/u/614755/futoase.github.com/how-to-use-ghost-py/yahoo-1.png" /></p>

<p>キャプチャーには成功しました。が文字が豆腐になっちゃっています。フォントがないから。フォントをインストールします。</p>
<pre class="highlight text">&gt; sudo apt-get install ttf-vlgothic
&gt; fc-cache -fv
</pre>
<p>再度キャプチャ。</p>

<p><img alt="Screen shot" src="https://dl.dropbox.com/u/614755/futoase.github.com/how-to-use-ghost-py/yahoo-2.png" /></p>

<p>ｷﾀ━━━━(ﾟ∀ﾟ)━━━━!!ということで成功。これでサーバー上でクロールさせて画像キャプチャだの、mechanize的な使い方もできるようになりました。</p>

<p>Ghost.py便利だし、何か活かしていきたいな。</p>

      </div>
    </div>

    <footer>
  <div>futoase 2009-2013 (c)</div>
</footer>

  </body>
</html>
