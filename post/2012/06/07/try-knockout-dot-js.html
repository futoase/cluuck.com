<!doctype html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />

  <title>Futoase development blog - try knockout.js</title>
  <link rel="stylesheet" href="/stylesheets/pygments.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/solarized-light.min.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/main.css" type="text/css" />

</head>


  <body>
    <header>
  <div>
    <a class="title" href="/">futoase development blog.</a>
    <span class="menu">
      <ul>
        <li><a href="/articles.html">articles</a></li>
        <li><a href="/tags.html">tags</a></li>
        <li><a href="/year.html">year</a></li>
	<li><a href="/me.html">me</a></li>
	<li><a href="/feed.xml">feed</a></li>
      </ul> 
    </span>
  </div>
</header>


    <div id="container">
      <div id="main" role="main">
        <h1>Knockout.jsを使ってみたい</h1>

<p>なんだか、社内で使ってる人がいるようだったから
触ってみよっかなーってことで確認します。</p>

<h2>Knockout.jsは何か</h2>

<ul>
<li>Java Script Application Flarmework</li>
<li><a href="http://ja.wikipedia.org/wiki/Model_View_ViewModel">MVVMアプリケーションアーキテクチャパターン</a>を利用している</li>
</ul>

<p>&hellip; そのぐらいしか認識していない。</p>

<h2>Knockout.jsを使う環境を整える</h2>

<p><a href="http://knockoutjs.com/">オフィシャルサイト</a>よりKnockout.jsをダウンロードするか、<a href="https://github.com/SteveSanderson/knockout">githubにあるKnockout.jsのリポジトリ</a>からcloneして利用する。
今回はgithubにあるKnockout.jsのリポジトリよりclone, 特定tagをcheckoutして利用する。</p>
<pre class="highlight text">$ git clone git://github.com/SteveSanderson/knockout.git knockoutjs
$ chmod +x knockoutjs/tools/check-trailing-space-linux
$ sh knockoutjs/build/build-linux
</pre>
<p>knockoutjs/output以下に２つのファイルが作成される。
- output/knockout-latest.debug.js
- output/knockout-latest.js</p>

<p>knockout-latest.debug.jsはminifyされていないものではあるのだが、今回はKnockout.jsを使ってみよう、ということなのでminifyされたjsを利用する。</p>

<p></p>

<h2>Knockout.jsを使ってみる</h2>

<p><a href="http://knockoutjs.com/examples/helloWorld.html">簡単なサンプル</a>を元にKnockout.jsを利用してみる。</p>
<pre class="highlight html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">/&gt;</span> 
    <span class="nt">&lt;title&gt;</span>Hello World<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      <span class="nt">&lt;p&gt;</span>First name: <span class="nt">&lt;input</span> <span class="na">data-bind=</span><span class="s">&quot;value: firstName&quot;</span><span class="nt">/&gt;&lt;/p&gt;</span>
      <span class="nt">&lt;p&gt;</span>Last name: <span class="nt">&lt;input</span> <span class="na">data-bind=</span><span class="s">&quot;value: lastName&quot;</span><span class="nt">/&gt;&lt;/p&gt;</span>
      <span class="nt">&lt;h2&gt;</span>Hello, <span class="nt">&lt;span</span> <span class="na">data-bind=</span><span class="s">&quot;text: fullName&quot;</span><span class="nt">/&gt;&lt;/h2&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;../src/knockout-latest.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;./hello.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
    <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="k">new</span> <span class="nx">ViewModel</span><span class="p">(</span><span class="s2">&quot;Taro&quot;</span><span class="p">,</span> <span class="s2">&quot;Yamada&quot;</span><span class="p">));</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre><pre class="highlight javascript"><span class="kd">var</span> <span class="nx">ViewModel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="nx">first</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">lastName</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="nx">last</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">computed</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">();</span>
  <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
<span class="p">};</span>
</pre>
<h2>動作サンプル</h2>

<p><a href="http://futoase.github.com/assets/2012-06-07-sample/hello/hello.html">動作サンプル</a>を置いておいた。
input form内の値を変更すると、自動的にfirstName, lastNameの値がたされた結果がh2要素内に反映される。これはko.computedメソッドにより、View側で束縛されている要素(data-bind=firstName, data-bind=lastName)の内容が変更されるとUI側に反映されるため。MVVMアーキテクチャは意識をせずにModelの変更内容がViewに反映される形のもの(反映するのはView-Model側)ということ。</p>

<h1>試しに何か簡単なものを作りたい</h1>

<p><a href="http://knockoutjs.com/documentation/introduction.html">公式のドキュメント</a>を参考にしながら、よさそうなbindingを使って見ながら何か作ってみたい。メモ書きできるものでも作ってみよう。</p>

<h2>メモ書きアプリ</h2>

<ul>
<li>メモが書ければ良い</li>
<li>localStorageに内容を保存できればよい</li>
</ul>

<h3>参考にしたもの</h3>

<p>公式に<a href="http://knockoutjs.com/documentation/foreach-binding.html">foreach bindings</a>のドキュメントが
あったので参考にした。</p>
<pre class="highlight text">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;/&gt;
    &lt;title&gt;メモ&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;p&gt;メモ: &lt;input size=&quot;100&quot; data-bind=&quot;value: description&quot;/&gt;&lt;/p&gt;
      &lt;button data-bind=&quot;click: addMemo&quot;&gt;Add Memo&lt;/button&gt;
    &lt;/div&gt;
    &lt;hr/&gt;
    &lt;div&gt;
      &lt;h1&gt;書かれたメモ&lt;/h1&gt;
      &lt;table&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;時間&lt;/th&gt;
            &lt;th&gt;内容&lt;/th&gt;
            &lt;th&gt;削除&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody data-bind=&quot;foreach: memos&quot;&gt;
          &lt;tr&gt;
            &lt;td data-bind=&quot;text: date&quot;&gt;&lt;/td&gt;
            &lt;td data-bind=&quot;text: memo&quot;&gt;&lt;/td&gt;
            &lt;td&gt;&lt;a href=&quot;#&quot; data-bind=&quot;click: $parent.removeMemo&quot;&gt;remove&lt;/a&gt;&lt;/td&gt;
          &lt;/tr&gt;
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  &lt;/body&gt;
  &lt;script type=&quot;text/javascript&quot; src=&quot;../src/knockout-latest.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; src=&quot;./memo.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot;&gt;
    ko.applyBindings(new MemoViewModel());
  &lt;/script&gt;
&lt;/html&gt;
</pre><pre class="highlight javascript"><span class="kd">var</span> <span class="nx">Utils</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">now</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">month</span> <span class="o">=</span> <span class="p">(</span><span class="nx">month</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">month</span> <span class="p">:</span> <span class="nx">month</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="p">(</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getDate</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">date</span> <span class="p">:</span> <span class="nx">date</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">hour</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hour</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">hour</span> <span class="p">:</span> <span class="nx">hour</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">minute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">minute</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">minute</span> <span class="p">:</span> <span class="nx">minute</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="p">(</span><span class="nx">second</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">second</span> <span class="p">:</span> <span class="nx">second</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> 
              <span class="nx">month</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">date</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
              <span class="nx">hour</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span>  <span class="nx">minute</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">second</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">})();</span>

<span class="kd">var</span> <span class="nx">Memos</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">saveMemos</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memos</span><span class="p">){</span>
      <span class="nx">localStorage</span><span class="p">[</span><span class="s1">&#39;memos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">memos</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">getMemos</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memos</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">localStorage</span><span class="p">[</span><span class="s1">&#39;memos&#39;</span><span class="p">]</span> <span class="p">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s1">&#39;memos&#39;</span><span class="p">])</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">})();</span>

<span class="kd">var</span> <span class="nx">MemoViewModel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="c1">// current element
</span>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">memos</span> <span class="o">=</span> <span class="nx">Memos</span><span class="p">.</span><span class="nx">getMemos</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">memos</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">memos</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observableArray</span><span class="p">(</span><span class="nx">memos</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">memos</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observableArray</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">addMemo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">description</span><span class="p">()</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">description</span><span class="p">().</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">memos</span><span class="p">.</span><span class="nx">unshift</span><span class="p">({</span>
        <span class="na">date</span><span class="p">:</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> 
        <span class="na">memo</span><span class="p">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">description</span><span class="p">()</span>
      <span class="p">});</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">description</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">Memos</span><span class="p">.</span><span class="nx">saveMemos</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">memos</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre>
<h2>結果</h2>

<p><a href="http://futoase.github.com/assets/2012-06-07-sample/memo/memo.html">動作サンプル</a>。</p>

<p>Viewで受け付けた変更をModelに即時反映される(View-Modelが)というのがなんとなく不思議。
色々作ってみたほうがいいだろう。
<a href="http://www.slideshare.net/iloire/building-web-apps-with-nodejs-socketio-knockoutjs-and-zombiejs-codemotion-2012">node.js + express + Knockout.js + Zombie.js という組み合わせがあるらしい。</a></p>

      </div>
    </div>

    <footer>
  <div>futoase 2009-2013 (c)</div>
</footer>

  </body>
</html>
